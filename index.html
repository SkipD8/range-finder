<!DOCTYPE html>
<html>
<head>
  <title>Range Finder</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    #distance {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 8px 12px;
      border-radius: 5px;
      font-family: Arial, sans-serif;
    }
    #clearBtn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 8px 12px;
      cursor: pointer;
      display: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="distance"></div>
  <button id="clearBtn">X</button>

  <script>
    let map;
    let userMarker;
    let userLocation;
    let tappedPoints = [];
    let lines = [];

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 18,
        mapTypeId: 'satellite',
        tilt: 0,
        rotateControl: false,
        fullscreenControl: false,
        streetViewControl: false
      });

      // Keep enforcing tilt to 0 when the user zooms or drags
      map.addListener('tilt_changed', () => {
        if (map.getTilt() !== 0) {
          map.setTilt(0);
        }
      });

      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(position => {
          userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          map.setCenter(userLocation);
          if (userMarker) {
            userMarker.setPosition(userLocation);
          } else {
            userMarker = new google.maps.Marker({
              position: userLocation,
              map: map,
              title: "You are here"
            });
          }
        }, () => {
          alert("Geolocation failed.");
        });
      } else {
        alert("Geolocation not supported.");
      }

      // Single tap: first line
      map.addListener("click", (e) => {
        if (tappedPoints.length === 0) {
          if (!userLocation) return;
          tappedPoints.push(userLocation);
          tappedPoints.push(e.latLng.toJSON());
          drawLine(userLocation, e.latLng.toJSON());
          updateDistance(userLocation, e.latLng.toJSON());
          document.getElementById("clearBtn").style.display = "block";
        }
      });

      // Double tap: next lines
      map.addListener("dblclick", (e) => {
        if (tappedPoints.length >= 1) {
          let lastPoint = tappedPoints[tappedPoints.length - 1];
          tappedPoints.push(e.latLng.toJSON());
          drawLine(lastPoint, e.latLng.toJSON());
          updateDistance(lastPoint, e.latLng.toJSON());
        }
      });

      // Clear button
      document.getElementById("clearBtn").addEventListener("click", () => {
        tappedPoints = [];
        lines.forEach(line => line.setMap(null));
        lines = [];
        document.getElementById("distance").innerText = "";
        document.getElementById("clearBtn").style.display = "none";
      });
    }

    function drawLine(from, to) {
      const line = new google.maps.Polyline({
        path: [from, to],
        geodesic: true,
        strokeColor: "#FF0000",
        strokeOpacity: 1.0,
        strokeWeight: 2,
        map: map
      });
      lines.push(line);
    }

    function updateDistance(from, to) {
      const R = 6371000; // meters
      const rad = Math.PI / 180;
      const lat1 = from.lat * rad;
      const lat2 = to.lat * rad;
      const dLat = (to.lat - from.lat) * rad;
      const dLon = (to.lng - from.lng) * rad;

      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1) * Math.cos(lat2) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const distanceMeters = R * c;
      const distanceYards = distanceMeters * 1.09361;

      document.getElementById("distance").innerText = 
        `Distance: ${distanceYards.toFixed(2)} yards`;
    }
  </script>
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBwmi4YVhFeyq3xJPTXId5k5ge-FJ2TTGg&callback=initMap">
  </script>
</body>
</html>
