<!DOCTYPE html>
<html>
<head>
  <title>Range Finder</title>
  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100%; width: 100%; }
    #clearBtn {
      position: absolute; top: 20px; right: 20px;
      background: transparent; color: #fff;
      font-family: 'Varela Round', sans-serif;
      font-size: calc(16.6vw); font-weight: 900;
      border: none; cursor: pointer; line-height: 1; z-index: 9999;
    }
    #centerBtn {
      position: absolute; top: 20px; left: 20px;
      width: calc(12vw); height: calc(12vw);
      background: transparent; border: 6px solid #fff; border-radius: 50%;
      cursor: pointer; z-index: 9999;
    }
    #rotationSlider {
      position: absolute; bottom: 60px; left: 50%;
      transform: translateX(-50%);
      width: 75%; height: 40px; -webkit-appearance: none;
    }
    #rotationSlider::-webkit-slider-runnable-track {
      height: 30px; background: #fff; border-radius: 50px;
    }
    #rotationSlider::-webkit-slider-thumb {
      -webkit-appearance: none; height: 50px; width: 50px;
      background: #4285F4; border-radius: 50%; margin-top: -10px;
      cursor: pointer; border: 3px solid #fff;
    }
    #rotationSlider:focus { outline: none; }
    #rotationSlider::-moz-range-track {
      height: 30px; background: #fff; border-radius: 50px;
    }
    #rotationSlider::-moz-range-thumb {
      height: 50px; width: 50px;
      background: #4285F4; border-radius: 50%;
      cursor: pointer; border: 3px solid #fff;
    }
    #version {
      position: absolute; bottom: 10px; right: 10px;
      color: white; font-family: monospace;
      background: rgba(0,0,0,0.5); padding: 4px 8px;
      border-radius: 4px; font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="clearBtn">X</button>
  <button id="centerBtn"></button>
  <input type="range" min="-180" max="180" value="0" id="rotationSlider">
  <div id="version">v1.6</div>

  <script>
    let map, userMarker, userLocation, watchId;
    let pointMarkers = [], lines = [], endDots = [], labels = [];
    let lastTouchAngle = null;
    let currentHeading = 0;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 18, mapTypeId: 'satellite', tilt: 45,
        rotateControl: false, fullscreenControl: false,
        streetViewControl: false, mapTypeControl: false
      });

      if (navigator.geolocation) {
        watchId = navigator.geolocation.watchPosition(pos => {
          userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          if (userMarker) {
            userMarker.setPosition(userLocation);
          } else {
            userMarker = new google.maps.Marker({
              position: userLocation, map: map, title: "You are here",
              icon: {
                path: google.maps.SymbolPath.CIRCLE, scale: 14,
                fillColor: '#4285F4', fillOpacity: 1,
                strokeWeight: 3, strokeColor: '#FFFFFF'
              }
            });
            map.setCenter(userLocation);
          }
        }, err => { alert("Geolocation error:\n" + err.message); },
        { enableHighAccuracy: true, maximumAge: 0, timeout: 1000 });
      } else {
        alert("Geolocation not supported.");
      }

      map.addListener("click", e => {
        if (pointMarkers.length === 0) {
          if (!userLocation) return;
          if (watchId) navigator.geolocation.clearWatch(watchId);
          addPointMarker(userLocation);
          addPointMarker(e.latLng.toJSON());
          redraw();
          document.getElementById("clearBtn").style.display = "block";
        }
      });

      map.addListener("dblclick", e => {
        if (pointMarkers.length >= 1) {
          addPointMarker(e.latLng.toJSON());
          redraw();
        }
      });

      document.getElementById("clearBtn").addEventListener("click", () => {
        pointMarkers.forEach(m => m.setMap(null));
        lines.forEach(l => l.setMap(null));
        endDots.forEach(d => d.setMap(null));
        labels.forEach(lbl => lbl.setMap(null));
        pointMarkers = []; lines = []; endDots = []; labels = [];
        document.getElementById("clearBtn").style.display = "none";
        if (navigator.geolocation) {
          watchId = navigator.geolocation.watchPosition(pos => {
            userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            if (userMarker) {
              userMarker.setPosition(userLocation);
            } else {
              userMarker = new google.maps.Marker({
                position: userLocation, map: map, title: "You are here",
                icon: {
                  path: google.maps.SymbolPath.CIRCLE, scale: 14,
                  fillColor: '#4285F4', fillOpacity: 1,
                  strokeWeight: 3, strokeColor: '#FFFFFF'
                }
              });
              map.setCenter(userLocation);
            }
          });
        }
      });

      document.getElementById("centerBtn").addEventListener("click", () => {
        if (userLocation) {
          map.setCenter(userLocation); map.setZoom(20);
        }
      });

      document.getElementById("rotationSlider").addEventListener("input", (e) => {
        const heading = Number(e.target.value);
        map.setHeading(-heading);
        currentHeading = -heading;
      });

      // Add two-finger rotation listeners
      const mapDiv = document.getElementById("map");
      mapDiv.addEventListener("touchstart", handleTouchStart, { passive: false });
      mapDiv.addEventListener("touchmove", handleTouchMove, { passive: false });
    }

    function handleTouchStart(e) {
      if (e.touches.length === 2) {
        lastTouchAngle = getAngle(e.touches[0], e.touches[1]);
      }
    }

    function handleTouchMove(e) {
      if (e.touches.length === 2 && lastTouchAngle !== null) {
        e.preventDefault(); // prevent scrolling
        const currentAngle = getAngle(e.touches[0], e.touches[1]);
        const delta = currentAngle - lastTouchAngle;
        currentHeading = (currentHeading + delta) % 360;
        map.setHeading(currentHeading);
        document.getElementById("rotationSlider").value = -currentHeading;
        lastTouchAngle = currentAngle;
      }
    }

    function getAngle(touch1, touch2) {
      const dx = touch2.clientX - touch1.clientX;
      const dy = touch2.clientY - touch1.clientY;
      return Math.atan2(dy, dx) * 180 / Math.PI;
    }

    function addPointMarker(position) {
      const marker = new google.maps.Marker({
        position: position, map: map, draggable: true, optimized: false,
        icon: {
          path: google.maps.SymbolPath.CIRCLE, scale: 50,
          fillColor: '#FFFFFF', fillOpacity: 1.0, strokeWeight: 0
        }
      });
      marker.addListener('drag', redraw);
      marker.addListener('dragend', redraw);
      pointMarkers.push(marker);
    }

    function redraw() {
      lines.forEach(line => line.setMap(null));
      endDots.forEach(dot => dot.setMap(null));
      labels.forEach(lbl => lbl.setMap(null));
      lines = []; endDots = []; labels = [];
      for (let i = 0; i < pointMarkers.length - 1; i++) {
        const from = pointMarkers[i].getPosition().toJSON();
        const to = pointMarkers[i + 1].getPosition().toJSON();
        drawLine(from, to); addEndDot(to); addLabel(from, to);
      }
    }

    function drawLine(from, to) {
      const line = new google.maps.Polyline({
        path: [from, to], geodesic: true,
        strokeColor: "#FFFFFF", strokeOpacity: 1.0, strokeWeight: 10, map: map
      });
      lines.push(line);
    }

    function addEndDot(position) {
      const dot = new google.maps.Marker({
        position: position, map: map,
        icon: {
          path: google.maps.SymbolPath.CIRCLE, scale: 14,
          fillColor: '#FFFFFF', fillOpacity: 1, strokeWeight: 0
        }
      });
      endDots.push(dot);
    }

    function addLabel(from, to) {
      const distanceYards = calculateDistance(from, to);
      const midLat = (from.lat + to.lat) / 2;
      const midLng = (from.lng + to.lng) / 2;
      const dx = to.lng - from.lng, dy = to.lat - from.lat;
      const length = Math.sqrt(dx * dx + dy * dy);
      const offsetFactor = 0.0003;
      const offsetLng = -dy / length * offsetFactor;
      const offsetLat = dx / length * offsetFactor;
      const offsetMidpoint = { lat: midLat + offsetLat, lng: midLng + offsetLng };
      const label = new google.maps.Marker({
        position: offsetMidpoint, map: map, icon: { path: 'M0 0', scale: 0 },
        label: {
          text: `${distanceYards.toFixed(0)}y`,
          fontSize: "36px", fontWeight: "bold",
          fontFamily: "Varela Round", color: "#FFFFFF"
        }
      });
      labels.push(label);
    }

    function calculateDistance(from, to) {
      const R = 6371000, rad = Math.PI / 180;
      const lat1 = from.lat * rad, lat2 = to.lat * rad;
      const dLat = (to.lat - from.lat) * rad, dLon = (to.lng - from.lng) * rad;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const distanceMeters = R * c; return distanceMeters * 1.09361;
    }
  </script>
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA3mH6gIcbi_WiWapx2mx4Jf_JacRQVrhw&callback=initMap"></script>
</body>
</html>
