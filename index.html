<!DOCTYPE html>
<html>
<head>
  <title>Range Finder v5</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    #version {
      position: absolute;
      top: 60px;
      left: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 12px;
      font-family: Arial, sans-serif;
      border-radius: 5px;
      z-index: 9999;
    }
    #distance {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 8px 12px;
      border-radius: 5px;
      font-family: Arial, sans-serif;
    }
    #clearBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: transparent;
      color: #fff;
      font-size: 28px;
      font-weight: bold;
      border: 2px solid #fff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      line-height: 34px;
      text-align: center;
      cursor: pointer;
      display: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="version">VERSION 5</div>
  <div id="distance"></div>
  <button id="clearBtn">X</button>

  <script>
    let map;
    let userMarker;
    let userLocation;
    let tappedPoints = [];
    let lines = [];
    let endDots = [];

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 18,
        mapTypeId: 'satellite',
        tilt: 0,
        rotateControl: false,
        fullscreenControl: false,
        streetViewControl: false,
        mapTypeControl: false  // Removes Map/Satellite toggle
      });

      // Enforce 2D
      map.addListener('tilt_changed', () => {
        if (map.getTilt() !== 0) {
          map.setTilt(0);
        }
      });

      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(position => {
          userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          console.log('Position updated:', userLocation);

          if (userMarker) {
            userMarker.setPosition(userLocation);
          } else {
            userMarker = new google.maps.Marker({
              position: userLocation,
              map: map,
              title: "You are here",
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 8,
                fillColor: '#4285F4',
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: '#FFFFFF'
              }
            });
            map.setCenter(userLocation);
          }

        }, (error) => {
          console.error('Geolocation error:', error);
          alert("Geolocation error:\n" + error.message + "\n(Code " + error.code + ")");
        }, {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 2000
        });
      } else {
        alert("Geolocation not supported.");
      }

      // Single tap: first line
      map.addListener("click", (e) => {
        if (tappedPoints.length === 0) {
          if (!userLocation) return;
          tappedPoints.push(userLocation);
          tappedPoints.push(e.latLng.toJSON());
          drawLine(userLocation, e.latLng.toJSON());
          updateDistance(userLocation, e.latLng.toJSON());
          addEndDot(e.latLng.toJSON());
          document.getElementById("clearBtn").style.display = "block";
        }
      });

      // Double tap: next lines
      map.addListener("dblclick", (e) => {
        if (tappedPoints.length >= 1) {
          let lastPoint = tappedPoints[tappedPoints.length - 1];
          tappedPoints.push(e.latLng.toJSON());
          drawLine(lastPoint, e.latLng.toJSON());
          updateDistance(lastPoint, e.latLng.toJSON());
          addEndDot(e.latLng.toJSON());
        }
      });

      // Clear button
      document.getElementById("clearBtn").addEventListener("click", () => {
        tappedPoints = [];
        lines.forEach(line => line.setMap(null));
        lines = [];
        endDots.forEach(dot => dot.setMap(null));
        endDots = [];
        document.getElementById("distance").innerText = "";
        document.getElementById("clearBtn").style.display = "none";
      });
    }

    function drawLine(from, to) {
      const line = new google.maps.Polyline({
        path: [from, to],
        geodesic: true,
        strokeColor: "#FFFFFF",
        strokeOpacity: 1.0,
        strokeWeight: 3,
        map: map
      });
      lines.push(line);
    }

    function addEndDot(position) {
      const dot = new google.maps.Marker({
        position: position,
        map: map,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 6,
          fillColor: '#FFFFFF',
          fillOpacity: 1,
          strokeWeight: 0
        }
      });
      endDots.push(dot);
    }

    function updateDistance(from, to) {
      const R = 6371000;
      const rad = Math.PI / 180;
      const lat1 = from.lat * rad;
      const lat2 = to.lat * rad;
      const dLat = (to.lat - from.lat) * rad;
      const dLon = (to.lng - from.lng) * rad;

      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1) * Math.cos(lat2) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const distanceMeters = R * c;
      const distanceYards = distanceMeters * 1.09361;

      document.getElementById("distance").innerText =
        `Distance: ${distanceYards.toFixed(2)} yards`;
    }
  </script>
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBQBkjoy2Cav_fjLsSparmutOgHpH68R4o&callback=initMap">
  </script>
</body>
</html>
